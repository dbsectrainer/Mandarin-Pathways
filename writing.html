<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mandarin Chinese writing practice - ä¸­æ–‡å†™ä½œç»ƒä¹ ">
    <title>Mandarin Pathways - Writing Practice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/writing.css">
    <script src="js/character-drawing.js" defer></script>
</head>
<body>
    <header>
        <h1>Mandarin Pathways</h1>
        <p><span class="zh">å¼€å¯æ‚¨çš„ä¸­æ–‡å­¦ä¹ ä¹‹æ—…</span><span class="en">Your Journey to Chinese Language Mastery</span></p>
    </header>

    <main>
        <!-- Return to top button -->
        <div class="return-to-top" id="returnToTop">
            <i class="fas fa-arrow-up"></i>
        </div>

        <!-- Visual anchor pattern -->
        <div class="visual-anchor" style="top: 5%; right: 5%;"></div>
        
        <div class="lesson-container">
            <div class="lesson-header">
                <div class="lesson-title">
                    <span class="flag" id="language-flag"></span>
                    <h2><span class="zh">å†™ä½œç»ƒä¹ ï¼š</span><span class="en">Writing Practice: </span><span id="activity-type"></span></h2>
                </div>
                <div class="language-selector">
                    <button class="language-btn" data-lang="zh"><span class="flag">ğŸ‡¨ğŸ‡³</span> ç®€ä½“ä¸­æ–‡</button>
                    <button class="language-btn" data-lang="pinyin"><span class="flag">ğŸ”¤</span> Pinyin</button>
                    <button class="language-btn" data-lang="en"><span class="flag">ğŸ‡ºğŸ‡¸</span> English</button>
                </div>
            </div>

            <div class="navigation">
                <a href="index.html" class="home-btn">
                    <i class="fas fa-home"></i> <span class="zh">è¿”å›é¦–é¡µ</span><span class="en">Back to Home</span>
                </a>
            </div>

            <div class="activity-selector">
                <h3><span class="zh">é€‰æ‹©æ´»åŠ¨ç±»å‹</span><span class="pinyin">XuÇnzÃ© huÃ³dÃ²ng lÃ¨ixÃ­ng</span><span class="en">Select Activity Type</span></h3>
                <div class="activity-buttons">
                    <button class="activity-btn" data-type="character">
                        <i class="fas fa-pen"></i> <span class="zh">æ±‰å­—ç»ƒä¹ </span><span class="pinyin">HÃ nzÃ¬ liÃ nxÃ­</span><span class="en">Character Practice</span>
                    </button>
                    <button class="activity-btn" data-type="sentence">
                        <i class="fas fa-align-left"></i> <span class="zh">å¥å­å®Œæˆ</span><span class="pinyin">JÃ¹zi wÃ¡nchÃ©ng</span><span class="en">Sentence Completion</span>
                    </button>
                    <button class="activity-btn" data-type="translation">
                        <i class="fas fa-language"></i> <span class="zh">ç¿»è¯‘ç»ƒä¹ </span><span class="pinyin">FÄnyÃ¬ liÃ nxÃ­</span><span class="en">Translation Practice</span>
                    </button>
                </div>
            </div>

            <div class="level-selector" style="display: none;">
                <h3><span class="zh">é€‰æ‹©éš¾åº¦çº§åˆ«</span><span class="pinyin">XuÇnzÃ© nÃ¡ndÃ¹ jÃ­biÃ©</span><span class="en">Select Difficulty Level</span></h3>
                <div class="level-buttons" id="level-buttons">
                    <!-- Levels will be dynamically added here based on activity type -->
                </div>
            </div>

            <div class="section-info">
                <h3 id="section-title"></h3>
                <p id="section-description"></p>
            </div>

            <div class="audio-player">
                <audio controls id="audio-player" type="audio/mpeg">
                    <span class="zh">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚</span><span class="en">Your browser does not support the audio element.</span>
                </audio>
                <div id="audio-fallback"></div>
            </div>

            <div class="writing-content" id="writing-content">
                <!-- Writing content will be dynamically added here -->
            </div>

            <div class="writing-tools">
                <h3><span class="zh">å†™ä½œå·¥å…·</span><span class="pinyin">XiÄ›zuÃ² gÅngjÃ¹</span><span class="en">Writing Tools</span></h3>
                <div class="tools-container">
                    <button id="clear-btn" class="tool-btn">
                        <i class="fas fa-eraser"></i> <span class="zh">æ¸…é™¤</span><span class="pinyin">QÄ«ngchÃº</span><span class="en">Clear</span>
                    </button>
                    <button id="check-btn" class="tool-btn">
                        <i class="fas fa-check"></i> <span class="zh">æ£€æŸ¥ç­”æ¡ˆ</span><span class="pinyin">JiÇnchÃ¡ dÃ¡'Ã n</span><span class="en">Check Answers</span>
                    </button>
                    <button id="show-answers-btn" class="tool-btn">
                        <i class="fas fa-eye"></i> <span class="zh">æ˜¾ç¤ºç­”æ¡ˆ</span><span class="pinyin">XiÇnshÃ¬ dÃ¡'Ã n</span><span class="en">Show Answers</span>
                    </button>
                </div>
            </div>

            <div class="lesson-actions">
                <button id="complete-btn" class="complete-btn">
                    <i class="fas fa-check"></i> <span class="zh">æ ‡è®°ä¸ºå·²å®Œæˆ</span><span class="pinyin">BiÄojÃ¬ wÃ©i yÇ wÃ¡nchÃ©ng</span><span class="en">Mark as Complete</span>
                </button>
            </div>

            <!-- Section divider with visual anchor -->
            <div class="section-divider"></div>
            
            <div class="navigation">
                <a href="index.html" class="home-btn">
                    <i class="fas fa-home"></i> <span class="zh">è¿”å›é¦–é¡µ</span><span class="en">Back to Home</span>
                </a>
            </div>
        </div>

        <!-- Visual anchor pattern -->
        <div class="visual-anchor" style="bottom: 10%; left: 5%;"></div>
    </main>

    <footer>
        <p>&copy; 2025 Mandarin Pathways | <span class="zh">èµ‹èƒ½ä¸­æ–‡å­¦ä¹ </span><span class="en">Empowering Chinese Language Learning</span></p>
    </footer>

    <div class="copy-notification" id="copy-notification">
        <span class="zh">çŸ­è¯­å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼</span><span class="en">Phrase copied to clipboard!</span>
    </div>

    <script>
        // Writing activities data structure
        const writingData = {
            character: {
                "Basic Strokes": {
                    title: "Basic Strokes",
                    titleZh: "åŸºæœ¬ç¬”ç”»",
                    titlePinyin: "JÄ«bÄ›n bÇhuÃ ",
                    description: "Practice the fundamental strokes used in Chinese characters",
                    descriptionZh: "ç»ƒä¹ æ±‰å­—ä¸­ä½¿ç”¨çš„åŸºæœ¬ç¬”ç”»",
                    descriptionPinyin: "LiÃ nxÃ­ HÃ nzÃ¬ zhÅng shÇyÃ²ng de jÄ«bÄ›n bÇhuÃ ",
                    hasAudio: true
                },
                "Common Radicals": {
                    title: "Common Radicals",
                    titleZh: "å¸¸ç”¨éƒ¨é¦–",
                    titlePinyin: "ChÃ¡ngyÃ²ng bÃ¹shÇ’u",
                    description: "Practice common radicals that form the building blocks of Chinese characters",
                    descriptionZh: "ç»ƒä¹ æ„æˆæ±‰å­—åŸºæœ¬ç»„æˆéƒ¨åˆ†çš„å¸¸ç”¨éƒ¨é¦–",
                    descriptionPinyin: "LiÃ nxÃ­ gÃ²uchÃ©ng HÃ nzÃ¬ jÄ«bÄ›n zÇ”chÃ©ng bÃ¹fÃ¨n de chÃ¡ngyÃ²ng bÃ¹shÇ’u",
                    hasAudio: true
                },
                "Numbers": {
                    title: "Numbers",
                    titleZh: "æ•°å­—",
                    titlePinyin: "ShÃ¹zÃ¬",
                    description: "Practice writing Chinese numbers",
                    descriptionZh: "ç»ƒä¹ ä¹¦å†™ä¸­æ–‡æ•°å­—",
                    descriptionPinyin: "LiÃ nxÃ­ shÅ«xiÄ› ZhÅngwÃ©n shÃ¹zÃ¬",
                    hasAudio: true
                },
                "Complete Radicals - Group 1": {
                    title: "Complete Radicals - Group 1",
                    titleZh: "å®Œæ•´éƒ¨é¦– - ç¬¬ä¸€ç»„",
                    titlePinyin: "WÃ¡nzhÄ›ng bÃ¹shÇ’u - DÃ¬ yÄ« zÇ”",
                    description: "Practice common radicals (1-30 of 214 Kangxi radicals)",
                    descriptionZh: "ç»ƒä¹ å¸¸ç”¨éƒ¨é¦–ï¼ˆåº·ç†™éƒ¨é¦–214ä¸ªä¸­çš„1-30ä¸ªï¼‰",
                    descriptionPinyin: "LiÃ nxÃ­ chÃ¡ngyÃ²ng bÃ¹shÇ’u (KÄngxÄ« bÃ¹shÇ’u 214 gÃ¨ zhÅng de 1-30 gÃ¨)",
                    hasAudio: true
                },
                "Complete Radicals - Group 2": {
                    title: "Complete Radicals - Group 2",
                    titleZh: "å®Œæ•´éƒ¨é¦– - ç¬¬äºŒç»„",
                    titlePinyin: "WÃ¡nzhÄ›ng bÃ¹shÇ’u - DÃ¬ Ã¨r zÇ”",
                    description: "Practice common radicals (31-60 of 214 Kangxi radicals)",
                    descriptionZh: "ç»ƒä¹ å¸¸ç”¨éƒ¨é¦–ï¼ˆåº·ç†™éƒ¨é¦–214ä¸ªä¸­çš„31-60ä¸ªï¼‰",
                    descriptionPinyin: "LiÃ nxÃ­ chÃ¡ngyÃ²ng bÃ¹shÇ’u (KÄngxÄ« bÃ¹shÇ’u 214 gÃ¨ zhÅng de 31-60 gÃ¨)",
                    hasAudio: true
                },
                "Complete Radicals - Group 3": {
                    title: "Complete Radicals - Group 3",
                    titleZh: "å®Œæ•´éƒ¨é¦– - ç¬¬ä¸‰ç»„",
                    titlePinyin: "WÃ¡nzhÄ›ng bÃ¹shÇ’u - DÃ¬ sÄn zÇ”",
                    description: "Practice common radicals (61-90 of 214 Kangxi radicals)",
                    descriptionZh: "ç»ƒä¹ å¸¸ç”¨éƒ¨é¦–ï¼ˆåº·ç†™éƒ¨é¦–214ä¸ªä¸­çš„61-90ä¸ªï¼‰",
                    descriptionPinyin: "LiÃ nxÃ­ chÃ¡ngyÃ²ng bÃ¹shÇ’u (KÄngxÄ« bÃ¹shÇ’u 214 gÃ¨ zhÅng de 61-90 gÃ¨)",
                    hasAudio: true
                },
                "HSK1 - Essential": {
                    title: "HSK1 Essential Characters",
                    titleZh: "HSK1 åŸºç¡€æ±‰å­—",
                    titlePinyin: "HSK1 jÄ«chÇ” HÃ nzÃ¬",
                    description: "Practice the most common characters from HSK Level 1",
                    descriptionZh: "ç»ƒä¹ HSKä¸€çº§ä¸­æœ€å¸¸ç”¨çš„æ±‰å­—",
                    descriptionPinyin: "LiÃ nxÃ­ HSK yÄ« jÃ­ zhÅng zuÃ¬ chÃ¡ngyÃ²ng de HÃ nzÃ¬",
                    hasAudio: true
                },
                "HSK2 - Basic": {
                    title: "HSK2 Basic Characters",
                    titleZh: "HSK2 åŸºæœ¬æ±‰å­—",
                    titlePinyin: "HSK2 jÄ«bÄ›n HÃ nzÃ¬",
                    description: "Practice common characters from HSK Level 2",
                    descriptionZh: "ç»ƒä¹ HSKäºŒçº§ä¸­çš„å¸¸ç”¨æ±‰å­—",
                    descriptionPinyin: "LiÃ nxÃ­ HSK Ã¨r jÃ­ zhÅng de chÃ¡ngyÃ²ng HÃ nzÃ¬",
                    hasAudio: true
                },
                "HSK3 - Intermediate": {
                    title: "HSK3 Intermediate Characters",
                    titleZh: "HSK3 ä¸­çº§æ±‰å­—",
                    titlePinyin: "HSK3 zhÅngjÃ­ HÃ nzÃ¬",
                    description: "Practice intermediate characters from HSK Level 3",
                    descriptionZh: "ç»ƒä¹ HSKä¸‰çº§ä¸­çš„ä¸­çº§æ±‰å­—",
                    descriptionPinyin: "LiÃ nxÃ­ HSK sÄn jÃ­ zhÅng de zhÅngjÃ­ HÃ nzÃ¬",
                    hasAudio: true
                },
                "Theme - Family": {
                    title: "Theme - Family",
                    titleZh: "ä¸»é¢˜ - å®¶åº­",
                    titlePinyin: "ZhÇ”tÃ­ - JiÄtÃ­ng",
                    description: "Practice characters related to family members and relationships",
                    descriptionZh: "ç»ƒä¹ ä¸å®¶åº­æˆå‘˜å’Œå…³ç³»ç›¸å…³çš„æ±‰å­—",
                    descriptionPinyin: "LiÃ nxÃ­ yÇ” jiÄtÃ­ng chÃ©ngyuÃ¡n hÃ© guÄnxÃ¬ xiÄngguÄn de HÃ nzÃ¬",
                    hasAudio: true
                },
                "Theme - Food": {
                    title: "Theme - Food",
                    titleZh: "ä¸»é¢˜ - é£Ÿç‰©",
                    titlePinyin: "ZhÇ”tÃ­ - ShÃ­wÃ¹",
                    description: "Practice characters related to food and dining",
                    descriptionZh: "ç»ƒä¹ ä¸é£Ÿç‰©å’Œç”¨é¤ç›¸å…³çš„æ±‰å­—",
                    descriptionPinyin: "LiÃ nxÃ­ yÇ” shÃ­wÃ¹ hÃ© yÃ²ngcÄn xiÄngguÄn de HÃ nzÃ¬",
                    hasAudio: true
                },
                "Theme - Travel": {
                    title: "Theme - Travel",
                    titleZh: "ä¸»é¢˜ - æ—…è¡Œ",
                    titlePinyin: "ZhÇ”tÃ­ - LÇšxÃ­ng",
                    description: "Practice characters related to travel and transportation",
                    descriptionZh: "ç»ƒä¹ ä¸æ—…è¡Œå’Œäº¤é€šç›¸å…³çš„æ±‰å­—",
                    descriptionPinyin: "LiÃ nxÃ­ yÇ” lÇšxÃ­ng hÃ© jiÄotÅng xiÄngguÄn de HÃ nzÃ¬",
                    hasAudio: true
                }
            },
            sentence: {
                "Beginner": {
                    title: "Beginner Sentence Completion",
                    titleZh: "åˆçº§å¥å­å®Œæˆ",
                    titlePinyin: "ChÅ«jÃ­ jÃ¹zi wÃ¡nchÃ©ng",
                    description: "Complete sentences with appropriate words",
                    descriptionZh: "ç”¨é€‚å½“çš„è¯è¯­å®Œæˆå¥å­",
                    descriptionPinyin: "YÃ²ng shÃ¬dÃ ng de cÃ­yÇ” wÃ¡nchÃ©ng jÃ¹zi",
                    hasAudio: true
                },
                "Intermediate": {
                    title: "Intermediate Sentence Completion",
                    titleZh: "ä¸­çº§å¥å­å®Œæˆ",
                    titlePinyin: "ZhÅngjÃ­ jÃ¹zi wÃ¡nchÃ©ng",
                    description: "Complete sentences with appropriate words or phrases",
                    descriptionZh: "ç”¨é€‚å½“çš„è¯è¯­æˆ–çŸ­è¯­å®Œæˆå¥å­",
                    descriptionPinyin: "YÃ²ng shÃ¬dÃ ng de cÃ­yÇ” huÃ² duÇnyÇ” wÃ¡nchÃ©ng jÃ¹zi",
                    hasAudio: true
                },
                "Advanced": {
                    title: "Advanced Sentence Completion",
                    titleZh: "é«˜çº§å¥å­å®Œæˆ",
                    titlePinyin: "GÄojÃ­ jÃ¹zi wÃ¡nchÃ©ng",
                    description: "Complete complex sentences with appropriate words or phrases",
                    descriptionZh: "ç”¨é€‚å½“çš„è¯è¯­æˆ–çŸ­è¯­å®Œæˆå¤æ‚å¥å­",
                    descriptionPinyin: "YÃ²ng shÃ¬dÃ ng de cÃ­yÇ” huÃ² duÇnyÇ” wÃ¡nchÃ©ng fÃ¹zÃ¡ jÃ¹zi",
                    hasAudio: true
                }
            },
            translation: {
                "Beginner": {
                    title: "Beginner Translation Exercises",
                    titleZh: "åˆçº§ç¿»è¯‘ç»ƒä¹ ",
                    titlePinyin: "ChÅ«jÃ­ fÄnyÃ¬ liÃ nxÃ­",
                    description: "Translate simple sentences between English and Chinese",
                    descriptionZh: "ç¿»è¯‘è‹±æ–‡å’Œä¸­æ–‡ä¹‹é—´çš„ç®€å•å¥å­",
                    descriptionPinyin: "FÄnyÃ¬ YÄ«ngwÃ©n hÃ© ZhÅngwÃ©n zhÄ«jiÄn de jiÇndÄn jÃ¹zi",
                    hasAudio: true
                },
                "Intermediate": {
                    title: "Intermediate Translation Exercises",
                    titleZh: "ä¸­çº§ç¿»è¯‘ç»ƒä¹ ",
                    titlePinyin: "ZhÅngjÃ­ fÄnyÃ¬ liÃ nxÃ­",
                    description: "Translate more complex sentences between English and Chinese",
                    descriptionZh: "ç¿»è¯‘è‹±æ–‡å’Œä¸­æ–‡ä¹‹é—´çš„æ›´å¤æ‚å¥å­",
                    descriptionPinyin: "FÄnyÃ¬ YÄ«ngwÃ©n hÃ© ZhÅngwÃ©n zhÄ«jiÄn de gÃ¨ng fÃ¹zÃ¡ jÃ¹zi",
                    hasAudio: true
                },
                "Advanced": {
                    title: "Advanced Translation Exercises",
                    titleZh: "é«˜çº§ç¿»è¯‘ç»ƒä¹ ",
                    titlePinyin: "GÄojÃ­ fÄnyÃ¬ liÃ nxÃ­",
                    description: "Translate complex sentences and paragraphs between English and Chinese",
                    descriptionZh: "ç¿»è¯‘è‹±æ–‡å’Œä¸­æ–‡ä¹‹é—´çš„å¤æ‚å¥å­å’Œæ®µè½",
                    descriptionPinyin: "FÄnyÃ¬ YÄ«ngwÃ©n hÃ© ZhÅngwÃ©n zhÄ«jiÄn de fÃ¹zÃ¡ jÃ¹zi hÃ© duÃ nluÃ²",
                    hasAudio: true
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const activityType = urlParams.get('type') || '';
            const level = urlParams.get('level') || '';
            const lang = urlParams.get('lang') || 'zh';
            
            // Set active language and update HTML lang attribute
            const languageBtns = document.querySelectorAll('.language-btn');
            languageBtns.forEach(btn => {
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                    // Set HTML lang attribute based on selected language
                    if (lang === 'en') {
                        document.documentElement.setAttribute('lang', 'en');
                    } else if (lang === 'zh') {
                        document.documentElement.setAttribute('lang', 'zh-CN');
                    } else {
                        // For pinyin, we'll use English as the base language
                        document.documentElement.setAttribute('lang', 'en');
                    }
                }
            });
            
            // Apply language filtering - show only elements for the selected language
            const allLangElements = document.querySelectorAll('.zh, .pinyin, .en');
            allLangElements.forEach(el => {
                // Hide all language elements first
                el.style.display = 'none';
            });
            
            // Show only elements for the selected language
            const selectedLangElements = document.querySelectorAll('.' + lang);
            selectedLangElements.forEach(el => {
                el.style.display = '';
            });
            
            // Add click event listeners to language buttons
            languageBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const currentType = urlParams.get('type') || '';
                    const currentLevel = urlParams.get('level') || '';
                    let newUrl = `writing.html?lang=${btn.dataset.lang}`;
                    if (currentType) {
                        newUrl += `&type=${currentType}`;
                        if (currentLevel) {
                            newUrl += `&level=${currentLevel}`;
                        }
                    }
                    window.location.href = newUrl;
                });
            });

            // Set language flag
            const flagMap = {
                'zh': 'ğŸ‡¨ğŸ‡³',
                'pinyin': 'ğŸ”¤',
                'en': 'ğŸ‡ºğŸ‡¸'
            };
            document.getElementById('language-flag').textContent = flagMap[lang];

            // Set up activity type buttons
            const activityBtns = document.querySelectorAll('.activity-btn');
            activityBtns.forEach(btn => {
                if (btn.dataset.type === activityType) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', () => {
                    window.location.href = `writing.html?type=${btn.dataset.type}&lang=${lang}`;
                });
            });

            // If activity type is selected, show levels
            if (activityType && writingData[activityType]) {
                document.querySelector('.level-selector').style.display = 'block';
                document.getElementById('activity-type').textContent = getActivityTypeDisplay(activityType, lang);
                
                // Populate levels
                const levelButtons = document.getElementById('level-buttons');
                levelButtons.innerHTML = '';
                
                Object.keys(writingData[activityType]).forEach(levelName => {
                    const btn = document.createElement('button');
                    btn.className = 'level-btn';
                    if (levelName === level) {
                        btn.classList.add('active');
                    }
                    btn.dataset.level = levelName;
                    
                    let icon = '';
                    if (activityType === 'sentence' || activityType === 'translation') {
                        if (levelName === 'Beginner') {
                            icon = '<i class="fas fa-star"></i> ';
                        } else if (levelName === 'Intermediate') {
                            icon = '<i class="fas fa-star"></i><i class="fas fa-star"></i> ';
                        } else if (levelName === 'Advanced') {
                            icon = '<i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> ';
                        }
                    } else {
                        icon = '<i class="fas fa-pen"></i> ';
                    }
                    
                    // Display level name in the appropriate language
                    let displayName = levelName;
                    const levelData = writingData[activityType][levelName];
                    
                    if (lang === 'zh' && levelData.titleZh) {
                        displayName = levelData.titleZh;
                    } else if (lang === 'pinyin' && levelData.titlePinyin) {
                        displayName = levelData.titlePinyin;
                    }
                    
                    btn.innerHTML = icon + displayName;
                    
                    btn.addEventListener('click', () => {
                        window.location.href = `writing.html?type=${activityType}&level=${levelName}&lang=${lang}`;
                    });
                    
                    levelButtons.appendChild(btn);
                });
            }

            // If both activity type and level are selected, load content
            if (activityType && level && writingData[activityType] && writingData[activityType][level]) {
                loadWritingContent(activityType, level, lang);
            } else {
                // Hide content sections if no level selected
                document.getElementById('section-title').textContent = '';
                document.getElementById('section-description').textContent = '';
                document.querySelector('.audio-player').style.display = 'none';
                document.getElementById('writing-content').innerHTML = '';
                document.querySelector('.writing-tools').style.display = 'none';
                document.getElementById('complete-btn').style.display = 'none';
            }

            // Writing tools functionality
            document.getElementById('clear-btn').addEventListener('click', () => {
                const inputs = document.querySelectorAll('.writing-input, .answer-input');
                inputs.forEach(input => {
                    input.value = '';
                });
            });

            document.getElementById('check-btn').addEventListener('click', () => {
                const exercises = document.querySelectorAll('.exercise-item');
                exercises.forEach(exercise => {
                    const input = exercise.querySelector('.writing-input, .answer-input');
                    const answer = exercise.dataset.answer;
                    
                    if (input && answer) {
                        if (input.value.trim().toLowerCase() === answer.toLowerCase()) {
                            input.classList.add('correct');
                            input.classList.remove('incorrect');
                        } else {
                            input.classList.add('incorrect');
                            input.classList.remove('correct');
                        }
                    }
                });
            });

            document.getElementById('show-answers-btn').addEventListener('click', () => {
                const exercises = document.querySelectorAll('.exercise-item');
                exercises.forEach(exercise => {
                    const input = exercise.querySelector('.writing-input, .answer-input');
                    const answer = exercise.dataset.answer;
                    
                    if (input && answer) {
                        input.value = answer;
                        input.classList.remove('incorrect');
                        input.classList.add('correct');
                    }
                });
            });

            // Mark as complete functionality
            const completeBtn = document.getElementById('complete-btn');
            const completedWritings = JSON.parse(localStorage.getItem('completedWritings') || '{}');
            
            if (activityType && level && completedWritings[`${activityType}_${level}_${lang}`]) {
                completeBtn.classList.add('completed');
                
                // Create language-specific completed text
                let completedText = '';
                if (lang === 'zh') {
                    completedText = 'å·²å®Œæˆ';
                } else if (lang === 'pinyin') {
                    completedText = 'YÇ wÃ¡nchÃ©ng';
                } else {
                    completedText = 'Completed';
                }
                
                completeBtn.innerHTML = `<i class="fas fa-check-circle"></i> ${completedText}`;
                completeBtn.disabled = true;
            }

            completeBtn.addEventListener('click', () => {
                if (activityType && level) {
                    // Mark writing activity as complete
                    completedWritings[`${activityType}_${level}_${lang}`] = true;
                    localStorage.setItem('completedWritings', JSON.stringify(completedWritings));
                    
                    // Update button state
                    completeBtn.classList.add('completed');
                    
                    // Create language-specific completed text
                    let completedText = '';
                    if (lang === 'zh') {
                        completedText = 'å·²å®Œæˆ';
                    } else if (lang === 'pinyin') {
                        completedText = 'YÇ wÃ¡nchÃ©ng';
                    } else {
                        completedText = 'Completed';
                    }
                    
                    completeBtn.innerHTML = `<i class="fas fa-check-circle"></i> ${completedText}`;
                    completeBtn.disabled = true;

                    // Show completion notification with language-specific text
                    const notification = document.getElementById('copy-notification');
                    
                    if (lang === 'zh') {
                        notification.textContent = 'æ´»åŠ¨å·²æ ‡è®°ä¸ºå®Œæˆï¼';
                    } else if (lang === 'pinyin') {
                        notification.textContent = 'HuÃ³dÃ²ng yÇ biÄojÃ¬ wÃ©i wÃ¡nchÃ©ng!';
                    } else {
                        notification.textContent = 'Activity marked as complete!';
                    }
                    notification.style.display = 'block';
                    notification.style.animation = 'none';
                    notification.offsetHeight; // Trigger reflow
                    notification.style.animation = 'fadeInOut 2s ease';
                    setTimeout(() => {
                        notification.style.display = 'none';
                        notification.textContent = 'Phrase copied to clipboard!';
                    }, 2000);
                }
            });
        });

        function getActivityTypeDisplay(type, lang) {
            if (lang === 'zh') {
                switch(type) {
                    case 'character': return 'æ±‰å­—ç»ƒä¹ ';
                    case 'sentence': return 'å¥å­å®Œæˆ';
                    case 'translation': return 'ç¿»è¯‘ç»ƒä¹ ';
                    default: return type;
                }
            } else if (lang === 'pinyin') {
                switch(type) {
                    case 'character': return 'HÃ nzÃ¬ liÃ nxÃ­';
                    case 'sentence': return 'JÃ¹zi wÃ¡nchÃ©ng';
                    case 'translation': return 'FÄnyÃ¬ liÃ nxÃ­';
                    default: return type;
                }
            } else {
                switch(type) {
                    case 'character': return 'Character Practice';
                    case 'sentence': return 'Sentence Completion';
                    case 'translation': return 'Translation Practice';
                    default: return type;
                }
            }
        }

        function loadWritingContent(activityType, level, lang) {
            const activityInfo = writingData[activityType][level];
            
            // Set section info with language-specific content
            if (lang === 'zh' && activityInfo.titleZh) {
                document.getElementById('section-title').textContent = activityInfo.titleZh;
                document.getElementById('section-description').textContent = activityInfo.descriptionZh;
            } else if (lang === 'pinyin' && activityInfo.titlePinyin) {
                document.getElementById('section-title').textContent = activityInfo.titlePinyin;
                document.getElementById('section-description').textContent = activityInfo.descriptionPinyin;
            } else {
                document.getElementById('section-title').textContent = activityInfo.title;
                document.getElementById('section-description').textContent = activityInfo.description;
            }
            
            // Show content sections
            document.querySelector('.audio-player').style.display = 'block';
            document.querySelector('.writing-tools').style.display = 'block';
            document.getElementById('complete-btn').style.display = 'block';
            
            // Pass the language parameter to the content formatting functions
            fetch(`writing_files/${activityType}_${level.toLowerCase().replace(/ /g, '_')}_${lang}.txt`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    formatAndDisplayWritingContent(text, activityType, lang);
                })
                .catch(error => {
                    console.error('Error loading writing content:', error);
                    const errorMessage = document.createElement('p');
                    errorMessage.className = 'error';
                    
                    // Create language-specific error messages
                    const zhError = document.createElement('span');
                    zhError.className = 'zh';
                    zhError.textContent = 'å†™ä½œå†…å®¹ä¸å¯ç”¨ã€‚è¯·å°è¯•å…¶ä»–æ´»åŠ¨æˆ–è¯­è¨€ã€‚';
                    
                    const pinyinError = document.createElement('span');
                    pinyinError.className = 'pinyin';
                    pinyinError.textContent = 'XiÄ›zuÃ² nÃ¨irÃ³ng bÃ¹ kÄ› yÃ²ng. QÇng chÃ¡ngshÃ¬ qÃ­tÄ huÃ³dÃ²ng huÃ² yÇ”yÃ¡n.';
                    
                    const enError = document.createElement('span');
                    enError.className = 'en';
                    enError.textContent = 'Writing content not available. Please try another activity or language.';
                    
                    errorMessage.appendChild(zhError);
                    errorMessage.appendChild(pinyinError);
                    errorMessage.appendChild(enError);
                    
                    document.getElementById('writing-content').innerHTML = '';
                    document.getElementById('writing-content').appendChild(errorMessage);
                    document.querySelector('.writing-tools').style.display = 'none';
                });
                
            // Load audio if available
            const audio = document.getElementById('audio-player');
            const audioFallback = document.getElementById('audio-fallback');
            
            if (activityInfo.hasAudio) {
                // For Pinyin, use Mandarin audio file
                const audioLang = lang === 'pinyin' ? 'zh' : lang;
                const audioPath = `audio_files/writing/${activityType}_${level.toLowerCase().replace(/ /g, '_')}_${audioLang}.mp3`;
                audio.src = audioPath;
                
                // Add a note only for Pinyin that it's using Mandarin audio
                if (lang === 'pinyin') {
                    audioFallback.innerHTML = '<p class="note"><i class="fas fa-info-circle"></i> Using Mandarin audio for reference.</p>';
                    audioFallback.style.display = 'block';
                } else {
                    audioFallback.style.display = 'none';
                }
            } else {
                audio.src = '';
                audioFallback.innerHTML = '<p class="note"><i class="fas fa-info-circle"></i> Audio not available for this activity.</p>';
                audioFallback.style.display = 'block';
            }
            
            // Load text content
            fetch(`writing_files/${activityType}_${level.toLowerCase().replace(/ /g, '_')}_${lang}.txt`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    formatAndDisplayWritingContent(text, activityType);
                })
                .catch(error => {
                    console.error('Error loading writing content:', error);
                    document.getElementById('writing-content').innerHTML = '<p class="error">Writing content not available. Please try another activity or language.</p>';
                    document.querySelector('.writing-tools').style.display = 'none';
                });
        }

        function formatAndDisplayWritingContent(text, activityType) {
            // Split the text into sections
            const sections = text.split(/\n(?=\w[^\n]+\n-+\n)/);
            
            if (sections.length >= 1) {
                const mainSection = sections[0];
                const lines = mainSection.split('\n');
                
                // Skip title and separator lines
                const contentLines = lines.slice(2);
                
                const writingContentDiv = document.getElementById('writing-content');
                writingContentDiv.innerHTML = '';
                
                if (activityType === 'character') {
                    formatCharacterPractice(contentLines, writingContentDiv);
                } else if (activityType === 'sentence') {
                    formatSentenceCompletion(contentLines, writingContentDiv);
                } else if (activityType === 'translation') {
                    formatTranslationExercises(contentLines, writingContentDiv);
                }
            }
        }

        function formatCharacterPractice(lines, container) {
            // Add instruction message at the top
            const instructionDiv = document.createElement('div');
            instructionDiv.className = 'instruction-message';
            instructionDiv.style.marginBottom = '20px';
            instructionDiv.style.padding = '10px';
            instructionDiv.style.backgroundColor = 'rgba(255, 255, 0, 0.1)';
            instructionDiv.style.borderRadius = '5px';
            instructionDiv.style.borderLeft = '4px solid #ffc107';
            
            const instructionIcon = document.createElement('i');
            instructionIcon.className = 'fas fa-info-circle';
            instructionIcon.style.marginRight = '8px';
            instructionIcon.style.color = '#ffc107';
            
            const instructionText = document.createElement('span');
            
            // Create language-specific instruction text
            const zhInstruction = document.createElement('span');
            zhInstruction.className = 'zh';
            zhInstruction.innerHTML = '<strong>ç»ƒä¹ æ–¹æ³•ï¼š</strong>ä½¿ç”¨é¼ æ ‡æˆ–è§¦æ‘¸å±åœ¨ç»˜å›¾æ¡†ä¸­ç»˜åˆ¶æ¯ä¸ªæ±‰å­—ã€‚æ‚¨å¯ä»¥ä½¿ç”¨"æ¸…é™¤"ã€"æ’¤é”€"å’Œ"æç¤º"æŒ‰é’®æ¥è¾…åŠ©ç»ƒä¹ ã€‚';
            
            const pinyinInstruction = document.createElement('span');
            pinyinInstruction.className = 'pinyin';
            pinyinInstruction.innerHTML = '<strong>LiÃ nxÃ­ fÄngfÇ:</strong> ShÇyÃ²ng shÇ”biÄo huÃ² chÃ¹mÅ pÃ­ng zÃ i huÃ¬tÃº kuÃ ng zhÅng huÃ¬zhÃ¬ mÄ›i gÃ¨ hÃ nzÃ¬. NÃ­n kÄ›yÇ shÇyÃ²ng "qÄ«ngchÃº", "chÃ¨xiÄo" hÃ© "tÃ­shÃ¬" Ã nniÇ” lÃ¡i fÇ”zhÃ¹ liÃ nxÃ­.';
            
            const enInstruction = document.createElement('span');
            enInstruction.className = 'en';
            enInstruction.innerHTML = '<strong>How to practice:</strong> Use your mouse or touch screen to draw each character in the drawing boxes. You can use the Clear, Undo, and Hint buttons to help with your practice.';
            
            instructionText.appendChild(zhInstruction);
            instructionText.appendChild(pinyinInstruction);
            instructionText.appendChild(enInstruction);
            
            instructionDiv.appendChild(instructionIcon);
            instructionDiv.appendChild(instructionText);
            container.appendChild(instructionDiv);
            
            let currentCharacter = null;
            let characterInfo = [];
            let characters = [];
            
            lines.forEach(line => {
                if (line.trim()) {
                    if (line.includes('_')) {
                        // This is a practice template line
                        if (currentCharacter) {
                            characters.push({
                                character: currentCharacter,
                                info: characterInfo,
                                template: line
                            });
                            currentCharacter = null;
                            characterInfo = [];
                        }
                    } else if (line.match(/^[\u4e00-\u9fa5]\s*-/)) {
                        // This is a new character line
                        if (currentCharacter) {
                            characters.push({
                                character: currentCharacter,
                                info: characterInfo
                            });
                            characterInfo = [];
                        }
                        currentCharacter = line.trim().split('-')[0].trim();
                        characterInfo.push(line);
                    } else {
                        // This is additional info about the current character
                        characterInfo.push(line);
                    }
                }
            });
            
            // Add the last character if there is one
            if (currentCharacter) {
                characters.push({
                    character: currentCharacter,
                    info: characterInfo
                });
            }
            
            // Create character practice elements
            characters.forEach(char => {
                const charDiv = document.createElement('div');
                charDiv.className = 'character-practice';
                
                // Character info
                const infoDiv = document.createElement('div');
                infoDiv.className = 'character-info';
                
                char.info.forEach(info => {
                    const p = document.createElement('p');
                    p.textContent = info;
                    infoDiv.appendChild(p);
                });
                
                charDiv.appendChild(infoDiv);
                
                // Character practice area
                const practiceDiv = document.createElement('div');
                practiceDiv.className = 'practice-area';
                
                const characterDisplay = document.createElement('div');
                characterDisplay.className = 'character-display';
                characterDisplay.textContent = char.character;
                
                const practiceGrid = document.createElement('div');
                practiceGrid.className = 'practice-grid';
                
                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'practice-cell';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'writing-input';
                    input.maxLength = 1;
                    
                    cell.appendChild(input);
                    practiceGrid.appendChild(cell);
                }
                
                practiceDiv.appendChild(characterDisplay);
                practiceDiv.appendChild(practiceGrid);
                
                charDiv.appendChild(practiceDiv);
                container.appendChild(charDiv);
            });
        }

        function formatSentenceCompletion(lines, container) {
            const exercises = [];
            let currentExercise = null;
            
            lines.forEach(line => {
                if (line.trim()) {
                    if (line.match(/^\d+\./)) {
                        // This is a new exercise
                        if (currentExercise) {
                            exercises.push(currentExercise);
                        }
                        currentExercise = {
                            prompt: line,
                            answer: '',
                            fullSentence: ''
                        };
                    } else if (line.toLowerCase().includes('answer:')) {
                        // This is the answer line
                        if (currentExercise) {
                            currentExercise.answer = line.split(':')[1].trim();
                        }
                    } else if (line.toLowerCase().includes('full sentence:')) {
                        // This is the full sentence line
                        if (currentExercise) {
                            currentExercise.fullSentence = line.split(':')[1].trim();
                        }
                    }
                }
            });
            
            // Add the last exercise if there is one
            if (currentExercise) {
                exercises.push(currentExercise);
            }
            
            // Create sentence completion elements
            exercises.forEach(exercise => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'exercise-item';
                exerciseDiv.dataset.answer = exercise.answer;
                
                const promptP = document.createElement('p');
                promptP.className = 'exercise-prompt';
                promptP.textContent = exercise.prompt;
                
                const inputDiv = document.createElement('div');
                inputDiv.className = 'exercise-input';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'answer-input';
                input.placeholder = 'Your answer...';
                
                inputDiv.appendChild(input);
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'exercise-result';
                resultDiv.style.display = 'none';
                
                exerciseDiv.appendChild(promptP);
                exerciseDiv.appendChild(inputDiv);
                exerciseDiv.appendChild(resultDiv);
                
                container.appendChild(exerciseDiv);
            });
        }

        function formatTranslationExercises(lines, container) {
            const exercises = [];
            let currentExercise = null;
            
            lines.forEach(line => {
                if (line.trim()) {
                    if (line.match(/^\d+\./)) {
                        // This is a new exercise
                        if (currentExercise) {
                            exercises.push(currentExercise);
                        }
                        currentExercise = {
                            source: line,
                            translation: ''
                        };
                    } else if (line.toLowerCase().includes('translation:')) {
                        // This is the translation line
                        if (currentExercise) {
                            currentExercise.translation = line.split(':')[1].trim();
                        }
                    }
                }
            });
            
            // Add the last exercise if there is one
            if (currentExercise) {
                exercises.push(currentExercise);
            }
            
            // Create translation exercise elements
            exercises.forEach(exercise => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'exercise-item';
                exerciseDiv.dataset.answer = exercise.translation;
                
                const sourceP = document.createElement('p');
                sourceP.className = 'exercise-prompt';
                sourceP.textContent = exercise.source;
                
                const inputDiv = document.createElement('div');
                inputDiv.className = 'exercise-input';
                
                const input = document.createElement('textarea');
                input.className = 'answer-input';
                input.placeholder = 'Your translation...';
                input.rows = 3;
                
                inputDiv.appendChild(input);
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'exercise-result';
                resultDiv.style.display = 'none';
                
                exerciseDiv.appendChild(sourceP);
                exerciseDiv.appendChild(inputDiv);
                exerciseDiv.appendChild(resultDiv);
                
                container.appendChild(exerciseDiv);
            });
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                const notification = document.getElementById('copy-notification');
                notification.style.display = 'block';
                notification.style.animation = 'none';
                notification.offsetHeight; // Trigger reflow
                notification.style.animation = 'fadeInOut 2s ease';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 2000);
            });
        }

        // Return to top functionality
        window.addEventListener('scroll', function() {
            const returnToTop = document.getElementById('returnToTop');
            if (window.scrollY > 500) {
                returnToTop.classList.add('visible');
            } else {
                returnToTop.classList.remove('visible');
            }
        });
        
        document.getElementById('returnToTop').addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
</body>
</html>
